#include <reg51.h>
#include <stdio.h>
#include <intrins.h>
#define uchar unsigned char
#define OSC 11059200

sbit RS=P1^7;
sbit RW=P1^6;
sbit E=P1^5;
sbit CLK=P1^0;
sbit DATA=P1^1;
sbit CS=P1^2;
sbit LCM_BLC=P1^3;

unsigned char code gaokuan[]="gaokuan208121222";
unsigned char i,l;

void delay()
{
	unsigned char j,k;
	for(j=0;j<255;j++)
		for(k=100;k>0;k--);
}

void fbusy()
{
 	  P2=0xff;
	  RS=0;
	  RW=1;
	  E=0;E=1;
	  while(P2&0x80)
	  {
	  	E=0;
		E=1;
	  }
 }

  void wc51r(uchar j)
 {
	fbusy();
	E=0;RS=0;RW=0;
	E=1;
	P2=j;
	E=0; 	
 }

 void wc51ddr(uchar j)
 {
 	fbusy();
	E=0;RS=1;RW=0;
	E=1;P2=j;
	E=0;
 }

 void init(void)
 {
 	wc51r(0x01);
	wc51r(0x38);
	wc51r(0x0c);
	wc51r(0x06);
 }

unsigned int ADConvert(void)
{
	int i;
	unsigned int ad;
	ad=0;
	DATA=1;
	CS=0;
	for(i=0;i<10;i++)
	{
		ad<<=1;
	    CLK=0;
	    _nop_();
	    _nop_();
	    _nop_();
	    CLK=1;
	    if(DATA) ad|=0x01;
	    else ad&=0xFFFE;
	 }
	 CS=1;
	 return ad;
}

  void main()
{
	unsigned int ad;
 	float adf;
 	unsigned int he;
 	unsigned char a,b,c;

 	SP=0x50;
	init();

	while(1)
	{
	//wc51r(0x80);
		for(i=0;i<16;i++)
		{
			wc51r(0x80+i);
			wc51ddr(gaokuan[i]);
			delay(); 
		}
		ad=ADConvert();
 		ad=ADConvert();
 		adf=(ad*5.0)/1024.0;

 		he=100*adf;
 		a=he%10+0x30;
 		b=(he/10)%10+0x30;
 		c=he/100+0x30;

		wc51r(0xc6);
		wc51ddr(c);
		wc51ddr('.');
		wc51ddr(b);
		wc51ddr(a);
		wc51ddr('V');
		delay();
	}
 }
