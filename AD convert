#include <reg51.h>
#include <stdio.h>
#include <intrins.h>

#define OSC 11059200
#define BAUDRATE 9600

sbit CLK=P1^0;
sbit DATA=P1^1;			
sbit CS=P1^2;

unsigned int ADConvert(void)
{
	int i;
	unsigned int ad;
	ad=0;
	DATA=1;
	CS=0;
	for(i=0;i<10;i++)
	{
		ad<<=1;
		CLK=0;
		_nop_();
		_nop_();
		_nop_();
		CLK=1;
		if(DATA) ad|=0x01;
		else ad&=0xFFFE;
	} 
	CS=1;
	return ad;
}	

void main(void)
{
	unsigned int i,j,ad;
	float adf;
	TMOD=0x20;
	SCON=0x50;
	PCON|=0x80;
	TL1=256-(OSC/12/16/BAUDRATE);
	TH1=256-(OSC/12/16/BAUDRATE);
	TR1=1;
	TI=1;
	printf("\r\nTCL1549 test starting...");
	while(1)
	{
		for(j=0;j<10;j++)for(i=0;i<10000;i++);
		ad=ADConvert();
		ad=ADConvert();
		adf=(ad*5.0)/1024.0;
		printf("\r\nSampled! Data = %04X(X),%u(D) 电压=%4.2fV ",ad,ad,adf);
	}
}

#include <reg51.h>
#include <stdio.h>
#include <intrins.h>

#define OSC 11059200
#define BAUDRATE 9600

extern ad;
sbit CLK=P1^0;
sbit DATA=P1^1;			
sbit CS=P1^2;

unsigned char code CharCode[]={0xc0,0xF9,0xA4,0xB0,0x99,0x92,0x82,0xF8,0x80,0x90,0x88,0x83,0xC6,0xA1,0x86,0x8E};

void delay(void)
{
	unsigned int k=50;
	while(k--);
}


unsigned int ADConvert(void)
{
	int i;
	unsigned int ad;
	ad=0;
	DATA=1;
	CS=0;
	for(i=0;i<10;i++)
	{
		ad<<=1;
		CLK=0;
		_nop_();
		_nop_();
		_nop_();
		CLK=1;
		if(DATA) 
		ad|=0x01;
		else 
		ad&=0xFFFE;
	} 
	CS=1;
	return ad;
}	

void shumaguan()
{
	unsigned char i,l,pos;

	P0=0;
	for(i=0;i<7;i++) P3=0xc0;
	
		for(l=0;l<4;l++)
		{
			P0=0x10;P2=CharCode[5];delay();
			P0=0x20;P2=CharCode[0];delay();
			P0=0x40;P2=CharCode[0];delay();
			P0=0x80;P2=CharCode[0];delay();
		}
	
}


void main(void)
{
	unsigned int i,j,ad;
	float adf;
	TMOD=0x20;
	SCON=0x50;
	PCON|=0x80;
	TL1=256-(OSC/12/16/BAUDRATE);
	TH1=256-(OSC/12/16/BAUDRATE);
	TR1=1;
	TI=1;
	printf("\r\nTCL1549 test starting...");
	while(1)
	{
		for(j=0;j<10;j++)for(i=0;i<10000;i++);
		ad=ADConvert();
		ad=ADConvert();
		adf=(ad*5.0)/1024.0;
		//printf("\r\nSampled! Data = %04X(X),%u(D) 电压=%4.2fV ",ad,ad,adf);
		shumaguan();
	}
}
